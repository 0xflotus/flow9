import form/form;

	SForm ::= BaseSForm, ControlSForm;
		BaseSForm ::= Text, Graphics, Picture, FixedSForm;
			FixedSForm : (width : double, height : double);

		ControlSForm ::= ResizeCell;

			// Resize the content to the available space, as well as optional alignment
			ResizeCell : (resizeToWidth : bool, resizeToHeight : bool, preserveAspectRatio : bool, alignX : double, alignY : double, content : BaseSForm);

	Coordinates(awh : Behaviour<WidthHeight>);

sform2form(coordinates : Coordinates, sform : SForm, outSize : DynamicBehaviour<WidthHeight>) -> Form {
	passSizeOutAndReturn = \width, height -> \form -> {
		next(outSize, WidthHeight(width, height));
		form
	};

	switch (sform : SForm) {
		ResizeCell(toW, toH, preserveAspect, alignX, alignY, content) : {
			awh = coordinates.awh;
			size = makeWH();

			select2(awh, size, \wh, sz -> if (sz.width > 0.0) wh.width / sz.width else 1.0);
			Empty();
		}
		default: Empty();
		FixedSForm(width, height) : Fixed(width, height) |> passSizeOutAndReturn(width, height);
	}
}

Fixed(width : double, height : double) -> Form {
	Empty();
}
makeWH() -> DynamicBehaviour<WidthHeight> {
	make(WidthHeight(0.0, 0.0));
}

select2(b1 : Behaviour<?>, b2 : Behaviour<??>, fn : (?, ??) -> ???) -> Behaviour<???> {
	const(fn(getValue(b1), getValue(b2)))
}
