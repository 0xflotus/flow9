import formats/wiki/wikistyle_types;
import form;

export {
	blankPrefix = "___";
	makeBlankString(name : string) -> string;
	getExternalFormTree(style : [WikiStyle]) -> Maybe<Tree<string, Form>>;
	useExternalForm(name : string, formTree : Tree<string, Form>) -> bool;
	getExternalForm(name : string, formTree : Tree<string, Form>) -> Form;
}

makeBlankString(name : string) -> string{
	blankPrefix + name
}

getBlankName(text : string) -> string{
	if (startsWith(text, blankPrefix)) substring(text, strlen(blankPrefix), strlen(text) - 3) 
	else "";
}

getExternalFormTree(style : [WikiStyle]) -> Maybe<Tree<string, Form>> {
	fold(style, None(), \acc, s -> switch(s){
		ExternallyGeneratedForms(f): {
			tree = f();
			if (sizeTree(tree) > 0)	Some(mapTree(tree, \ws -> ws(style)))
			else acc;
		}
		default: acc;
	});
}	

getExternalForm(text : string, formTree : Tree<string, Form>) -> Form {
	blankName = getBlankName(text);
	if (blankName != "") either(lookupTree(formTree, blankName), Empty())
	else Empty();
}

useExternalForm(text : string, formTree : Tree<string, Form>) -> bool{
	getBlankName(text) != "" && sizeTree(formTree) > 0
}

