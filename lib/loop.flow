import array;


export {
	loop(from : ?, step : (?) -> ?, condition : (?) -> bool, action : (?) -> void) -> void;
	while(condition : () -> bool, action : () -> void) -> void;
	collectorLoop(from : ?, step : (?) -> ?, condition : (?) -> bool, action : (?) -> ??) -> [??];

	foldWhile(xs : [?], init : ??, fn : (??, ?) -> Maybe<??>) -> ??;
	foldWhile2(xs : [?], init : ??, fn : (??, ?) -> Pair<??, bool>) -> ??;
	foldiWhile(xs : [?], init : ??, fn : (int, ??, ?) -> Maybe<??>) -> ??;
	updateWhile(init : ??, fn : (??) -> Maybe<??>) -> ??;
	updateWhile2(init : ??, fn : (??) -> Pair<??, bool>) -> ??;
}

loop(from : ?, step : (?) -> ?, condition : (?) -> bool, action : (?) -> void) -> void {
	if (condition(from)) {
		action(from);
		loop(step(from), step, condition, action);
	};
}

collectorLoop(from : ?, step : (?) -> ?, condition : (?) -> bool, action : (?) -> ??) -> [??] {
	result = ref [];

	loop(from, step, condition, \i-> {
		result := arrayPush(^result, action(i));
	});

	^result;
}

while(condition : () -> bool, action : () -> void) -> void {
	if (condition()) {
		action();
		while(condition, action);
	};
}

foldWhile(xs : [?], init : ??, fn : (??, ?) -> Maybe<??>) -> ?? {
	if (length(xs) > 0) {
		res = fn(init, xs[0]);

		if (isSome(res)) {
			foldWhile(tail(xs), either(res, init), fn)
		} else {
			init
		}
	} else {
		init
	}
}

foldWhile2(xs : [?], init : ??, fn : (??, ?) -> Pair<??, bool>) -> ?? {
	if (length(xs) > 0) {
		res = fn(init, xs[0]);

		if (secondOfPair(res)) {
			foldWhile2(tail(xs), firstOfPair(res), fn)
		} else {
			init
		}
	} else {
		init
	}
}

foldiWhile(xs : [?], init : ??, fn : (int, ??, ?) -> Maybe<??>) -> ?? {
	foldiWhile2(xs, init, 0, fn)
}

foldiWhile2(xs : [?], init : ??, i : int, fn : (int, ??, ?) -> Maybe<??>) -> ?? {
	if (length(xs) > 0) {
		res = fn(i, init, xs[0]);

		if (isSome(res)) {
			foldiWhile2(tail(xs), either(res, init), i + 1, fn)
		} else {
			init
		}
	} else {
		init
	}
}

updateWhile(init : ??, fn : (??) -> Maybe<??>) -> ?? {
	res = fn(init);

	if (isSome(res)) {
		updateWhile(either(res, init), fn)
	} else {
		init
	}
}

updateWhile2(init : ??, fn : (??) -> Pair<??, bool>) -> ?? {
	res = fn(init);

	if (secondOfPair(res)) {
		updateWhile2(firstOfPair(res), fn)
	} else {
		firstOfPair(res)
	}
}