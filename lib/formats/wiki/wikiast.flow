import formats/wiki/wikimath;
import formats/wiki/wikivariables;
import paragraphalignments;
import ui/imagedecoratedstructs;
import ui/playeroptions;

export {
	WikiConstruction ::= WikiBaseTextEx, WikiSimpleTextEx, WikiNoWikiEx, WikiWigiEx, WikiAnsEx, WikiSmartArtEx, WikiDecoratedImageEx, WikiOneLineEx, WikiSpanEx,
		WikiTableEx, WikiLearningResourceEx, WikiWriteEx, WikiMediaEx, WikiSubscriptMathEx, WikiSubscriptEx, WikiSuperscriptMathEx,
		WikiSuperscriptEx, WikiSubSupEx, WikiUnderlineEx, WikiBoldItalicEx, WikiBoldEx, WikiItalicEx, ConditionalWikiEx, WikiDebugEx, WikiButtonEx,
		WikiPicButtonEx, WikiSliderEx, WikiScoringIconEx, MathRootEx, MathLongDivisionEx, MathStrikeEx, WikiUnderline2Ex, MathNaturalSyntaxEx,
		WikiRotateEx, WikiScaleEx, WikiMutableEx, MathFracEx, MathBracketEx, DefiniteControlEx, MathScriptEx, MathDottedEx, CustomSymbol,
		WikiTopModificatorEx, WikiDraggableEx, WikiForcedExpandEx, WikiPopupEx, WikiSelectEx, WikiSequenceEx, GlueFragments, WikiNewLine, MathNumber2StringEx, MathNumber2SciNotEx,
		WikiLimiterEx, WikiWhenEx, WikiScoreEx, WikiCaseEx, WikiConditionalAssignment, WikiRepeatEx, WikiComboBoxEx, WikiTimelineEx, WikiBlankEx,
		WikiMessagesCollectorEx, WikiDroptargetEx, WikiPredefinedColorEx, WikiSimpleConstructions, WikiRadioButtonsEx, WikiInlineBullet, WikiCalc, WikiAltTextCollectorEx, MathUnknownConstruction,
		MathAssignmentsOnBecameVisibleEx;

		WikiBaseTextEx(text : string);
		WikiSimpleTextEx(text : string, styleAddition : [CharacterStyle]);
		WikiNoWikiEx(text : string);
		WikiWigiEx(src : string);
		WikiAnsEx(src : string);
		WikiSmartArtEx(src : string);
		WikiDecoratedImageEx(imageDecorated : ImageDecorated);
		WikiOneLineEx(constructions : [WikiConstruction]);
		WikiSpanEx(constructions : [WikiConstruction], tooltip : Maybe<string>, color : Maybe<int>, background : Maybe<int>, fontFamily : Maybe<string>, fontSizeMultiplier : Maybe<Pair<double, bool>>);
		WikiTableEx(constructions : [WikiConstruction], tableStyle : WikiTableStyle);
		WikiLearningResourceEx(lr : string, introduction : Maybe<string>);
		WikiWriteEx(src : string);
		WikiMediaEx(contentType : MediaContent2);
		WikiSubscriptMathEx(constructions : [WikiConstruction]);
		WikiSubscriptEx(src : string);
		WikiSuperscriptMathEx(constructions : [WikiConstruction]);
		WikiSuperscriptEx(src : string);
		WikiSubSupEx(bodyC : [WikiConstruction], supC : [WikiConstruction], subC : [WikiConstruction], left : bool, src : string);
		WikiUnderlineEx(src : string);
		WikiBoldItalicEx(constructions : [WikiConstruction]);
		WikiBoldEx(constructions : [WikiConstruction]);
		WikiItalicEx(constructions : [WikiConstruction], fix : bool);
		WikiConditionalAssignment : (condition : WV_Sequence, thenSequence : WV_Sequence, elseSequence : WV_Sequence);
		MathAssignmentsOnBecameVisibleEx : (sequence : WV_Sequence);
		ConditionalWikiEx(condition : WV_Sequence, thenConstructions : [WikiConstruction], elseConstructions : [WikiConstruction]);
		WikiWhenEx(conditionSequence : WV_Sequence, thenConstructions : [WikiConstruction], elseConstructions : [WikiConstruction]);
		WikiScoreEx(almostCorrectSequence : Maybe<WV_Sequence>, missingSequence : Maybe<WV_Sequence>, conditionSequence : WV_Sequence, tooltip : string, vertical : bool, inIconTooltip : string);
		WikiDebugEx(src : string);
		WikiButtonEx(header : string, seq : WV_Sequence, width : double);
		WikiPicButtonEx(seq : WV_Sequence, button : [WikiConstruction], hovered : Maybe<[WikiConstruction]>, pressed : Maybe<[WikiConstruction]>);
		WikiSliderEx(varName : string, minSeq : WV_Sequence, maxSeq : WV_Sequence, stepSeq : WV_Sequence, widthSeq : WV_Sequence);
		WikiForcedExpandEx(src : string);
		WikiSelectEx(triggerVars : [string], constructions : [WikiConstruction]);
		WikiCaseEx(conditionSeq : WV_Sequence, cases : [[WikiConstruction]]);
		WikiRepeatEx(timesSeq : WV_Sequence, constructions : [WikiConstruction]);
		WikiBlankEx(width : double, matching : WikiBlankMatchingOptions, answers : WikiBlankAnswersData);
			WikiBlankMatchingOptions(caseSensitive : bool, exactMatch : bool, signTolerance : string, decimalTolerance: int);
			WikiBlankAnswersData ::= WikiBlankAnswersLegacyData, WikiBlankAnswers2Data;
				WikiBlankAnswersLegacyData(scoring : WikiBlankLegacyScoring, answers : [WikiBlankAnswer]); //WikiBlankAnswer.type is ignored
				WikiBlankAnswers2Data(scoring : WikiBlank2Scoring, answers : [WikiBlankAnswer]);
				WikiBlankScoring ::= WikiBlankLegacyScoring, WikiBlank2Scoring;
					WikiBlankLegacyScoring(varScore : Maybe<string>, varNAnswer : Maybe<string>, varNumVal : Maybe<string>);
					WikiBlank2Scoring(vGeneralCorrectnessMB : Maybe<string>, vAnswerIndexMB : Maybe<string>, vIsMisstypedMB : Maybe<string>, vAnswerTypeMB : Maybe<string>, vAnswerValueMB : Maybe<string>);
					WikiBlankAnswer(answer : string, type : WikiBlankAnswerType);
		WikiScoringIconEx(type : WikiScoringIconType, tooltip : string);
		WikiComboBoxEx(varName : string, suggestedWidth : double, reorderElements : bool, items : [string]);
		WikiTimelineEx(varName : string, duration : WV_Sequence, maxVal : WV_Sequence, widthVal : WV_Sequence, doLoop : bool, maxLoopsCount : int);
		MathNumber2StringEx(seq : WV_Sequence);
		MathNumber2SciNotEx(numberSequence : WV_Sequence, digitsCountSequence : WV_Sequence, trailingZeroes : bool);
		MathRootEx(degreeConstructions : [WikiConstruction], bodyConstructions : [WikiConstruction], src : string);
		MathLongDivisionEx(bodyConstructions : [WikiConstruction], src : string);
		MathStrikeEx(bodyConstructions : [WikiConstruction], dxSeq : WV_Sequence, dySeq : WV_Sequence, mcolor : Maybe<int>, src : string);
		WikiUnderline2Ex(bodyConstructions : [WikiConstruction], dySeq : WV_Sequence, dlSeq : WV_Sequence, drSeq : WV_Sequence);
		MathNaturalSyntaxEx(src : string);
		WikiRotateEx(bodyConstructions : [WikiConstruction], ansleSeq : WV_Sequence);
		WikiScaleEx(bodyConstructions : [WikiConstruction], scaleSeq : WV_Sequence);
		WikiMutableEx(name : string);
		MathFracEx(enumeratorConstructions : [WikiConstruction], denumeratorConstructions : [WikiConstruction], src : string);
		MathBracketEx(leftBracket : WriteBracketType, rightBracket : WriteBracketType, bodyConstructions : [WikiConstruction], src : string);
		DefiniteControlEx(signType : DefiniteControlSignType, tc : [WikiConstruction], fc : [WikiConstruction], bc : [WikiConstruction]);
		MathScriptEx(type : MathScriptType, bodyConstructions : [WikiConstruction], scriptConstructions : [WikiConstruction], src : string);
			MathScriptType ::= MathOverscript, MathUnderscript, MathSuperscript, MathSubscript;
		MathDottedEx(bodyConstructions : [WikiConstruction], left : int, top : int, right : int, bottom : int, leftSing : bool, rightSign : bool, src : string);
		WikiTopModificatorEx(type : WriteTopModificator, size : WriteTopModificatorSize, bodyConstructions : [WikiConstruction], dySeq : WV_Sequence, dlSeq : WV_Sequence, dxSeq : WV_Sequence, naturalMath : bool);
		WikiDraggableEx(wikiConstructions : [WikiConstruction], shapeConstructions : [WikiConstruction], feedbackConstructions : [WikiConstruction], strokeShapeS : string, fillShapeS : string, idSeq : WV_Sequence, dwSeq : WV_Sequence, dhSeq : WV_Sequence, strkSeq : WV_Sequence, flSeq : WV_Sequence);
		WikiDroptargetEx(varName : string, wikiConstructions : [WikiConstruction], feedbackConstructions : [WikiConstruction], strokeShapeS : string, fillShapeS : string, idSeq : WV_Sequence, dwSeq : WV_Sequence, dhSeq : WV_Sequence, strkSeq : WV_Sequence, flSeq : WV_Sequence);
		WikiPopupEx(wikiConstructions : [WikiConstruction], wdSeq : WV_Sequence, htSeq : WV_Sequence, hASeq : WV_Sequence, vASeq : WV_Sequence);
		WikiSequenceEx(sequence : WV_Sequence);
		WikiLimiterEx(triggrVars : [string], resVar : string, cond : string, valSeq : WV_Sequence);
		WikiMessagesCollectorEx(otherAnswer : string, varName : string, correctAnswer : [string]);
		WikiPredefinedColorEx(color : int, constructions : [WikiConstruction]);
		// Artifical construction for translation purposes
		WikiSimpleConstructions(constructions : [WikiConstruction], src : string);
		WikiRadioButtonsEx(varName : string, wrap : bool, vertical : bool, widthSeq : WV_Sequence, variants : [[WikiConstruction]], variantsS : [string]);
		WikiAltTextCollectorEx(altText : string);



		// Style for table
		WikiTableStyle(graphic : [GraphicsStyle], character : [CharacterStyle], xAlign : double, yAlign : double, xAligns : [double], yAligns : [double], vLines : [int], hLines : [int], left : WriteBracketType, right : WriteBracketType, borders : WikiTableCellBorders);
		WikiTableCellBorders : (left : double, top : double, right : double, bottom : double);
		wikiTableDefaultStyle = WikiTableStyle([], [], 0.0, 0.0, [], [], [], [], WriteNoBracket(), WriteNoBracket(), WikiTableCellBorders(6.0, 6.0, 6.0, 6.0));

		MediaContent ::= VideoContent, PictureContent, ExternalLink, SoundContent, ExpressContent, NotContent;
		MediaContent2 ::= VideoContent, PictureContent, ExternalLink, SoundContent, ExpressContent;
			VideoContent:(url:string, options: [PlayerOption], controls: [PlayerControl], zoom : Maybe<double>);
			PictureContent:(url:string, title : Maybe<string>, zoom: ZoomDescription);
			ExternalLink:(url : string, caption : Maybe<string>);
			SoundContent:(url : string, options : [PlayerOption]);
			ExpressContent:(url : string, title : Maybe<string>, zoom: ZoomDescription);
			NotContent:();

	isSimpleWikiConstruction(construction : WikiConstruction) -> bool;
}


dummyWikiAstAssignment = 0;

isSimpleWikiConstruction(construction : WikiConstruction) {
	checkConstructions = \constructions -> all(map(constructions, isSimpleWikiConstruction));
	switch(construction : WikiConstruction) {
		WikiBaseTextEx(__) : true;
		WikiSimpleTextEx(__, __) : true;
		WikiNoWikiEx(__) : true;
		WikiWigiEx(__) : false;
		WikiAnsEx(__) : false;
		WikiSmartArtEx(__) : false;
		WikiDecoratedImageEx(__) : false;
		WikiOneLineEx(constructions) : checkConstructions(constructions);
		WikiSpanEx(constructions, __, __, __, __, __) : checkConstructions(constructions);
		WikiTableEx(constructions, __) : length(constructions) > 0 && checkConstructions(constructions);
		WikiLearningResourceEx(__, __) : false;
		WikiWriteEx(__) : false;
		WikiMediaEx(__) : false;
		WikiSubscriptMathEx(constructions) : checkConstructions(constructions);
		WikiSubscriptEx(src) : true;
		WikiSuperscriptMathEx(constructions) : checkConstructions(constructions);
		WikiSuperscriptEx(src) : true;
		WikiSubSupEx(bodyC, supC, subC, __, __) : checkConstructions(bodyC) && checkConstructions(supC) && checkConstructions(subC);
		WikiUnderlineEx(src) : true;
		WikiBoldItalicEx(constructions) : checkConstructions(constructions);
		WikiBoldEx(constructions) : checkConstructions(constructions);
		WikiItalicEx(constructions, __) : checkConstructions(constructions);
		WikiConditionalAssignment(__, __, __) : false;
		MathAssignmentsOnBecameVisibleEx(__) : false;
		ConditionalWikiEx(__, thenConstructions, elseConstructions) : checkConstructions(thenConstructions) && checkConstructions(elseConstructions);
		WikiWhenEx(__, thenConstructions, elseConstructions) : checkConstructions(thenConstructions) && checkConstructions(elseConstructions);
		WikiScoreEx(__, __, __, __, __, __) : false;
		WikiDebugEx(__) : true;
		WikiButtonEx(__, __, __) : false;
		WikiPicButtonEx(__, button, hovered, pressed) : checkConstructions(button) && eitherMap(hovered, checkConstructions, true) && eitherMap(pressed, checkConstructions, true);
		WikiSliderEx(__, __, __, __, __) : false;
		WikiForcedExpandEx(src) : false;
		WikiSelectEx(__, constructions) :  checkConstructions(constructions);
		WikiCaseEx(__, cases) : all(map(cases,  checkConstructions));
		WikiRepeatEx(__, constructions) :  checkConstructions(constructions);
		WikiBlankEx(__, __, __) : false;
		WikiScoringIconEx(__, __) : false;
		WikiInlineBullet() : false;
		WikiComboBoxEx(__, __, __, __) : false;
		WikiRadioButtonsEx(__, __, __, __, __, __) : false;
		WikiTimelineEx(__, __, __, __, __, __) : false;
		MathNumber2StringEx(__) : false;
		MathNumber2SciNotEx(__, __, __) : false;
		MathRootEx(degreeConstructions, bodyConstructions, __) : checkConstructions(degreeConstructions) && checkConstructions(bodyConstructions);
		MathLongDivisionEx(bodyConstructions, __) : checkConstructions(bodyConstructions);
		MathStrikeEx(bodyConstructions, __, __, __, __) : checkConstructions(bodyConstructions);
		WikiUnderline2Ex(bodyConstructions, __, __, __) : checkConstructions(bodyConstructions);
		MathNaturalSyntaxEx(src) : false;
		WikiRotateEx(bodyConstructions, __) : checkConstructions(bodyConstructions);
		WikiScaleEx(bodyConstructions, __) : checkConstructions(bodyConstructions);
		WikiMutableEx(__) : false;
		MathFracEx(enumeratorConstructions, denumeratorConstructions, __) : checkConstructions(enumeratorConstructions) && checkConstructions(denumeratorConstructions);
		MathBracketEx(__, __, bodyConstructions, __) : checkConstructions(bodyConstructions);
		DefiniteControlEx(__, tc, fc, bc) : checkConstructions(tc) && checkConstructions(fc) && checkConstructions(bc);
		MathScriptEx(__, bodyConstructions, scriptConstructions, __) : checkConstructions(bodyConstructions) && checkConstructions(scriptConstructions);
		MathDottedEx(bodyConstructions, __, __, __, __, __, __, __) : checkConstructions(bodyConstructions);
		WikiTopModificatorEx(__, __, bodyConstructions, __, __, __, __) : checkConstructions(bodyConstructions);
		WikiDraggableEx(__, __, __, __, __, __, __, __, __, __) : false;
		WikiDroptargetEx(__, __, __, __, __, __, __, __, __, __) : false;
		WikiPopupEx(__, __, __, __, __) : false;
		WikiSequenceEx(__) : false;
		WikiLimiterEx(__, __, __, __) : false;
		WikiMessagesCollectorEx(__, __, __) : false;
		WikiAltTextCollectorEx(__) : false;
		WikiPredefinedColorEx(__, constructions) : checkConstructions(constructions);
		// Artifical construction for translation purposes
		WikiSimpleConstructions(constructions, __) : true;
		GlueFragments() : true;
		WikiNewLine() : false;
		WikiCalc() : false;
		CustomSymbol(__) : true;
		MathUnknownConstruction(__) : true;
	}
}
