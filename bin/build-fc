#!/bin/bash
echo ""
echo "Compiling 'Flowcompiler'"
echo "========================"
echo ""
set -e

if [ `uname` == Darwin ]; then
    READLINK=greadlink
else
    READLINK=readlink
fi

SCRIPT_FN=`$READLINK -e "$0"`
SCRIPT_DIR=`dirname "$SCRIPT_FN"`

BASE_DIR=`$READLINK -e "$SCRIPT_DIR/.."`

echo "* Compiling runtime"
echo "  -----------------"
echo ""

pushd $BASE_DIR/src/java
javac -g com/area9innovation/flow/*.java
popd

echo ""
echo "* Generating the Java modules for flowcompiler"
echo "  --------------------------------------------"
echo ""
flowcompiler1 file=tools/flowcompiler/flowcompiler.flow java=javagen verbose=1

echo ""
echo "* Compiling the generated code"
echo "  ----------------------------"
echo ""

javac -Xlint:unchecked -encoding UTF-8 -cp src/java javagen/*.java

echo ""
echo "* Building the 'flowcompiler.jar'"
echo "  -------------------------------"
echo ""

echo Main-Class: javagen.Main > Manifest.txt 

jar cfm tools/flowcompiler/flowcompiler.jar Manifest.txt javagen/*.class -C src/java com/area9innovation/flow

echo ""
echo "Done."